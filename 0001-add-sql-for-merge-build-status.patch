From 6c85ff59efa9ec02af75de40849e0ddd9671ea7f Mon Sep 17 00:00:00 2001
From: qishanqing <18310287801@163.com>
Date: Sat, 27 Jan 2018 16:51:04 +0800
Subject: [PATCH] add sql for merge/build status


Signed-off-by: qishanqing <18310287801@163.com>
---
 jenkins/template.xml |   42 +++++++++++------------
 sh/jenkins-upload.sh |    7 ++++
 sh/jenkins.sh        |   93 ++++++++++++++++++++++++++++++++++++++++++++++---
 sh/svn-merged.sh     |   31 +++++++++++-----
 sh/svn.sh            |   19 ++++++----
 5 files changed, 146 insertions(+), 46 deletions(-)

diff --git a/jenkins/template.xml b/jenkins/template.xml
index 30dd99e..9966d0d 100755
--- a/jenkins/template.xml
+++ b/jenkins/template.xml
@@ -1,25 +1,26 @@
 <?xml version='1.0' encoding='UTF-8'?>
-<maven2-moduleset plugin="maven-plugin@2.7.1">
+<maven2-moduleset plugin="maven-plugin@2.17">
   <actions/>
-  <description>构建10环境Web项目</description>
+  <description>%description%</description>
   <keepDependencies>false</keepDependencies>
   <properties>
     <jenkins.model.BuildDiscarderProperty>
       <strategy class="hudson.tasks.LogRotator">
         <daysToKeep>-1</daysToKeep>
-        <numToKeep>3</numToKeep>
+        <numToKeep>5</numToKeep>
         <artifactDaysToKeep>-1</artifactDaysToKeep>
         <artifactNumToKeep>-1</artifactNumToKeep>
       </strategy>
     </jenkins.model.BuildDiscarderProperty>
   </properties>
-  <scm class="hudson.scm.SubversionSCM" plugin="subversion@1.54">
+  <scm class="hudson.scm.SubversionSCM" plugin="subversion@2.9">
     <locations>
       <hudson.scm.SubversionSCM_-ModuleLocation>
-        <remote>https://192.168.0.220/svn/tech/Branch/20170710-批量修改三方限额/Develop/基础业务/三方网关/GatewayBusiness</remote>
+        <remote>%svnurl%</remote>
+        <credentialsId>b5ef5c85-6a9d-4cf8-89bc-fa16ff19efd4</credentialsId>
         <local>.</local>
         <depthOption>infinity</depthOption>
-        <ignoreExternalsOption>false</ignoreExternalsOption>
+        <ignoreExternalsOption>true</ignoreExternalsOption>
       </hudson.scm.SubversionSCM_-ModuleLocation>
     </locations>
     <excludedRegions></excludedRegions>
@@ -27,25 +28,26 @@
     <excludedUsers></excludedUsers>
     <excludedRevprop></excludedRevprop>
     <excludedCommitMessages></excludedCommitMessages>
-    <workspaceUpdater class="hudson.scm.subversion.UpdateUpdater"/>
+    <workspaceUpdater class="hudson.scm.subversion.CheckoutUpdater"/>
     <ignoreDirPropChanges>false</ignoreDirPropChanges>
     <filterChangelog>false</filterChangelog>
   </scm>
-  <canRoam>true</canRoam>
+  <assignedNode>bulid1||build2||master</assignedNode>
+  <canRoam>false</canRoam>
   <disabled>false</disabled>
   <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
   <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
   <triggers/>
   <concurrentBuild>false</concurrentBuild>
   <rootModule>
-    <groupId>com.dafy.accountbusiness</groupId>
-    <artifactId>GatewayBusiness</artifactId>
+    <groupId>com.dafy.life.mobilecarriers</groupId>
+    <artifactId>MobileCarriersBusiness</artifactId>
   </rootModule>
   <goals>clean -Pprod package  -U -Dmaven.test.skip=true</goals>
-  <defaultGoals>install</defaultGoals>
   <aggregatorStyleBuild>true</aggregatorStyleBuild>
   <incrementalBuild>false</incrementalBuild>
   <ignoreUpstremChanges>false</ignoreUpstremChanges>
+  <ignoreUnsuccessfulUpstreams>false</ignoreUnsuccessfulUpstreams>
   <archivingDisabled>false</archivingDisabled>
   <siteArchivingDisabled>false</siteArchivingDisabled>
   <fingerprintingDisabled>false</fingerprintingDisabled>
@@ -59,23 +61,19 @@
   <globalSettings class="jenkins.mvn.DefaultGlobalSettingsProvider"/>
   <reporters/>
   <publishers/>
-  <buildWrappers/>
+  <buildWrappers>
+    <org.jenkinsci.plugins.builduser.BuildUser plugin="build-user-vars-plugin@1.5"/>
+  </buildWrappers>
   <prebuilders/>
   <postbuilders>
     <hudson.tasks.Shell>
-      <command>warname=`/bin/ls ${WORKSPACE}/target |grep war |awk -F &quot;.&quot; &apos;{print $1}&apos; |awk -F &quot;-&quot; &apos;{print $1}&apos;`
-label=`/bin/echo ${SVN_URL} |awk -F &quot;/&quot; &apos;{print $NF}&apos;`
-/bin/rm -rf /deploy/$label/$warname
-/bin/mkdir -p /deploy/${label}/${warname}
-/usr/bin/unzip -o ${WORKSPACE}/target/${warname}*.war -d /deploy/${label}/${warname}
-/rsync_push/rsync.sh ${label} ${warname} 10
-</command>
+      <command>%command%</command>
     </hudson.tasks.Shell>
   </postbuilders>
   <runPostStepsIfResult>
-    <name>SUCCESS</name>
-    <ordinal>0</ordinal>
-    <color>BLUE</color>
+    <name>FAILURE</name>
+    <ordinal>2</ordinal>
+    <color>RED</color>
     <completeBuild>true</completeBuild>
   </runPostStepsIfResult>
 </maven2-moduleset>
diff --git a/sh/jenkins-upload.sh b/sh/jenkins-upload.sh
index ae35252..98520ad 100755
--- a/sh/jenkins-upload.sh
+++ b/sh/jenkins-upload.sh
@@ -13,6 +13,13 @@ version=$SVN_REVISION
 job_name=$BUILD_URL
 owner=$BUILD_USER_ID
 
+if [ -e /home/qishanqing/tmp/logs/task_id.log ];then
+    task_id=`cat /home/qishanqing/tmp/logs/task_id.log`
+    rm -f /home/qishanqing/tmp/logs/task_id.log
+    export task_id
+fi
+
+
 
 function upload_version () {
     rm -rf upload
diff --git a/sh/jenkins.sh b/sh/jenkins.sh
index 4c4bf2a..4b7c165 100755
--- a/sh/jenkins.sh
+++ b/sh/jenkins.sh
@@ -1,5 +1,11 @@
 #!/bin/bash
 
+#set -e
+#mkdir -p ~/tmp/$(basename $0)
+#cd ~/tmp/$(basename $0)
+#JENKINS_BUILDER_NOW=$(now.)
+
+source /home/qishanqing/myscript/sh/cmdb
 set -x
 
 echo pid is $$
@@ -7,8 +13,8 @@ die() {
 	(
 	echo "$@"
 	if test -e ~/tmp/jenkins/output.$$;then
-		echo
-		cat ~/tmp/jenkins/output.$$
+		Error=`cat ~/tmp/jenkins/output.$$`
+		echo $Error		
 	fi
 	) | mails_cm -i "jenkins auto web do failed"
 	rm -f ~/tmp/jenkins/output.$$
@@ -16,6 +22,20 @@ die() {
 	exit -1
 }
 
+die1() {
+	(
+	echo "$@"
+	if test -e ~/tmp/jenkins/output.$$;then
+		Error=`cat ~/tmp/jenkins/output.$$`
+		echo $Error		
+	fi
+	) | mails_cm -i "jenkins auto web do failed"
+	rm -f ~/tmp/jenkins/output.$$
+	cmdb_mysql "update svn set"
+	kill $$
+	exit -1
+}
+
 TEMP=$(getopt -o a:d:n:c:T:e:E:h --long types:,email:,extra_mails:,add:,copy:,del:,num:,help -n $(basename -- $0) -- "$@")
 add=
 email=
@@ -84,7 +104,8 @@ clean-jenkins-workspace() {
 }
 
 jenkins-clean-never-run () {
-	j=`java -jar   $jenkins_cli -s $jenkins_url/ list-jobs`
+    j=`java -jar   $jenkins_cli -s $jenkins_url/ list-jobs`
+    export j
 	for x in $j;do
 		c=`curl --user qishanqing:372233 --silent -f  $jenkins_url/job/$x/lastBuild/buildNumber`
 		if test -z "$c";then
@@ -105,15 +126,75 @@ jenkins-job-add() {
 }
 
 jenkins-job-build() {
-	(
-		java -jar   $jenkins_cli -s $jenkins_url/ build "$add" || true
-	) >~/tmp/jenkins/output.$$ 2>&1 || die "jenkins job build failed"
+        (
+	        get-job-info
+		java -jar   $jenkins_cli -s $jenkins_url/ build "$add"
+	) 
 }
 
 jenkins-job-del() {
 	java -jar   $jenkins_cli -s $jenkins_url/ delete-job $del  >~/tmp/jenkins/output.$$ 2>&1 || die "jenkins job del failed"
 }
 
+function get-build-description() {
+    echo owner: ${extra_mails%@*}
+    echo
+    echo
+    echo branch: $del
+}
+
+function output-manifest.xml-from-template() {
+    template="/home/qishanqing/myscript/jenkins/template.xml"
+    
+    export assignedNode=$(
+	echo "build2||build1||master"
+	   )
+    if [ -z $build_command ];then
+	build_command="source /home/qishanqing/myscript/sh/jenkins-upload.sh"
+    fi
+
+    svnurl=$del
+    
+#    if [ -z $svnurl ];then
+#	die "请输入需要编译的svn路径"
+#    fi
+
+    export svnurl
+    export build_description=$(get-build-description)
+    export build_command
+
+    cat $template | perl -npe '                                                                                                                                                                
+        s,%description%,<![CDATA[$ENV{build_description}]]>,g;                                                                                                                                
+        s,%svnurl%,<![CDATA[$ENV{svnurl}]]>,g;                                                                                                                                       
+        s,%command%,<![CDATA[$ENV{build_command}]]>,g;                                                                                                                                      
+    '
+}
+
+get-job-info() {
+    if [ -z $add ];then
+	die "项目名称不能为空"
+    else
+	java -jar   $jenkins_cli -s $jenkins_url/ get-job $add >~/tmp/jenkins/template.xml || mails_cm -i "$add------项目不存在，马上为你新建"
+    fi
+    
+
+    if [ ! -s ~/tmp/jenkins/template.xml ];then
+	output-manifest.xml-from-template >  ~/tmp/jenkins/template.xml
+	cat ~/tmp/jenkins/template.xml | java -jar   $jenkins_cli -s $jenkins_url/ create-job $add >~/tmp/jenkins/output.$$ 2>&1 || die "jenkins job create failed"
+    fi
+
+    branch_name=`cat ~/tmp/jenkins/template.xml | grep remote | perl -npe 's,<.*?>,,;s,</.*?>,,'`
+    if [ -e ~/tmp/logs/task_id.log ];then
+  	echo $copy > ~/tmp/logs/task_id.log
+    else
+	(
+	    cd ~/tmp/logs
+      	    touch task_id.log
+       	    echo $copy > ~/tmp/logs/task_id.log
+	)
+    fi
+}
+
 job-info() {
 (
 cat << EOF
diff --git a/sh/svn-merged.sh b/sh/svn-merged.sh
index 8e95ddb..26bc7e3 100755
--- a/sh/svn-merged.sh
+++ b/sh/svn-merged.sh
@@ -202,7 +202,7 @@ function svn_conflict_trees(){
 			svn co $branch ~/tmp/conflict/$branch  > /dev/null
 			cd ~/tmp/conflict/$branch
 			for x in `cat ~/tmp/project_list.txt`;do
-			    cp-with-dir-struct $Basetrunkcode $x
+			    cp-with-dir-struct $Basetrunkcode $x > /dev/null
 			done
 			echo > ~/tmp/project_list.txt
 		    )
@@ -211,6 +211,18 @@ function svn_conflict_trees(){
 		mvn_check && svn st | grep "^?" | awk '{print $2}' | xargs  svn add >/dev/null 2>&1
 }
 
+function commit() {
+    info=`svn st | wc -l`
+    task_id=`cmdb_mysql "SELECT task_id FROM svn WHERE tag_name='${tag3:-$branch}';"`
+    if [ $info -eq 0 ];then
+	cmdb_mysql "insert into merge(branch_name,task,branch_date,path,owner,status,remarks,task_id) values ('${tag1:-$branch}','$task',now(),'${branch#*Develop/}','${owner%@*}','1','code合并内容为空','${task_id:-0}');"
+	exit 0
+    fi
+   
+    svn ci -m "$task
+Merged revision(s) $revision-$head  from ${tag3:-${branch#*tech/}}" | cmdb_mysql "insert into merge(branch_name,task,branch_date,path,owner,status,remarks,task_id) values ('${tag1:-$branch}','$task',now(),'${branch#*Develop/}','${owner%@*}','0','success','${task_id:-0}');"
+}
+
 function svn_from_tb_merged() {
 		(
 		set -x
@@ -247,19 +259,21 @@ function svn_from_tb_merged() {
 				svn_conflict_files
 				svn_conflict_trees
 			fi
-		svn ci -m "$task
-Merged revision(s) $revision-$head  from ${tag3:-${branch#*tech/}}" ||  
+			commit ||
 				(
 				svn_conflict_files
 				svn_conflict_trees
-		svn ci -m "$task
-Merged revision(s) $revision-$head  from ${tag3:-${branch#*tech/}}"
+				commit
 				)
 		else
 			if [ -z "$revision" ];then
 		            local revision=`svn log --search "新建项目开发分支" "${branch}" | head -n 2 | grep ^r | awk -F '|' '{print$1}'`
 		    	fi
 
+			if [ -z "$revision" ];then
+		            local revision=`svn log --search "新建分支项目" "${branch}" | head -n 2 | grep ^r | awk -F '|' '{print$1}'`
+		    	fi
+			
 		    	if [ -z "$revision" ];then
 			    local revision=`svn log --search "新建主干项目" "${trunk}" | head -n 2 | grep ^r | awk -F '|' '{print$1}'`
 		    	fi
@@ -274,16 +288,13 @@ Merged revision(s) $revision-$head  from ${tag3:-${branch#*tech/}}"
 					svn_conflict_trees
 				fi
 			fi
-		svn ci -m "$task
-Merged revision(s) $revision-$head  from ${tag3:-${branch#*tech/}}"  || 
+			commit || 
 				(
 				svn_conflict_files
 				svn_conflict_trees
-		svn ci -m "$task
-Merged revision(s) $revision-$head  from ${tag3:-${branch#*tech/}}" 
+				commit
 				)
 		fi
-		cmdb_mysql "insert into merge(branch_name,task,branch_date,path,owner) values ('$branch','$task',now(),'${branch#*Develop/}','${owner%@*}');"
 		) | mails_cm -i "code merged from  ${branch#*tech/}" || true
 }
 
diff --git a/sh/svn.sh b/sh/svn.sh
index e0da659..2040f35 100755
--- a/sh/svn.sh
+++ b/sh/svn.sh
@@ -118,7 +118,7 @@ function addtrunk() {
 		echo -e "\033[37m 2. 输入Trunk之后的项目路径 \033[0m"
 	else
 		inport_source
-#		svn list ${Trunk_name}${source_name##*/} >/dev/null 2>&1 || if ! [ '$?' -eq 0 ];then return 0;else  mails_cm -i "主干已存在";exit 1;fi 
+#		svn list ${Trunk_name}${source_name##*/} >/dev/null 2>&1 || if ! [ '$?' -eq 0 ];then return 0;else  mails_cm -i "主干已存在";exit -1;fi 
 		svn copy ${branch} ${trunk} --parents -m "新建主干项目"
 		echo "新建主干项目路径: ${trunk}                       "
 	fi
@@ -171,14 +171,16 @@ function createtag() {
 		tag_name=$tag_name/${TIME_DIR}_${version:-$head}
 		st=`cmdb_mysql "SELECT tag_name FROM svn WHERE version='$head' and branch_name='$branch';"`
 		ftp_name=`cmdb_mysql "SELECT ftp_version_name FROM svn WHERE version='$head' and branch_name='$branch';"`
+		info="此次代码更新没有变化"
+		info1="新建tag"
 		if test ! -z "$st";then
 		    if [ `echo "$st" | wc -l` -ge 2 ];then
-			echo "此次代码更新没有变化,基于现在最新的分支版本已有 $st"
+			echo "$info,基于现在最新的分支版本已有 $st"
 		    fi   
 		else
 		    svn copy ${branch} ${tag_name}  --parents -m "${message:-新建tag---${TIME_DIR}_${version:-$head}}"
-		    cmdb_mysql "insert into svn(branch_name,tag_name,tag_date,owner,version,job_name,ftp_version_name) values ('$branch', '$tag_name',now(),'${owner:-qishanqing}','${version:-$head}','$job_name','$file');"  
-		    echo "新建tag: ${tag_name}"
+		    cmdb_mysql "insert into svn(branch_name,tag_name,tag_date,owner,version,job_name,ftp_version_name,task_id,remarks,status) values ('$branch', '$tag_name',now(),'${owner:-qishanqing}','${version:-$head}','$job_name','$file','${task_id:-0}','$info1','0');"  
+		    echo "$info1: ${tag_name}"
 		fi
 		if test "$SKIP_FTP_VERSION" = true;then
 		    echo "一个分支多个项目,不再检查上传的ftp版本"
@@ -186,20 +188,21 @@ function createtag() {
 		else
 		    if test ! -z "$ftp_name";then
 			if [ `echo "$ftp_name" | wc -l` -ge 2 ];then
-			    echo "此次代码更新没有变化,基于现在最新的分支版本已有 $ftp_name"
+			    echo "$info,基于现在最新的分支版本已有 $ftp_name"
+			    cmdb_mysql "update svn set task_id='${task_id:-0}',status='1',remarks='$info' where version='$head' and branch_name='$branch';"
 			    exit 0
 			else
-			    cmdb_mysql "update svn set job_name='$job_name',ftp_version_name='$file' where version='$head' and branch_name='$branch';"
+			    cmdb_mysql "update svn set job_name='$job_name',ftp_version_name='$file',status='0' where task_id='${task_id:-0}';"
 			fi
 		    fi
 		fi
 	    else
-		echo "现在支持分支自动打tag，请切换至对应分支试试吧"
+		echo "现在支持分支自动打tag，请切换至对应分支"
+		exit 0
 		ftp_name1=`cmdb_mysql "SELECT ftp_version_name FROM svn WHERE tag_name='$branch';"`
 		if test ! -z "$ftp_name1";then
 		    if [ `echo "$ftp_name1" | wc -l` -ge 2 ];then
 			echo "基于本次的tag版本已有 $ftp_name1"
-			exit 0
 		    else
 			cmdb_mysql "update svn set job_name='$job_name',ftp_version_name='$file' where tag_name='$branch';"
 		    fi
-- 
1.7.1

