#!/bin/bash
set -x 

die() {
    (
        echo $(date):  Error: "$@"
        echo
    ) |
        (
            flock /home/qishanqing/system-config/logs/cmdb.err.lock tee -a /home/qishanqing/system-config/logs/cmdb.err.txt
        )
    exit -1
}

branch=`echo $branch_name | awk -F '/'  '{print $7}'`
access=${TIME_DIR}-$P2

TEMP=$(getopt -o a:u:g:h --long auth:,user:,group:,help -n $(basename -- $0) -- "$@")
auther=
user_access=
group_access=
eval set -- "$TEMP"
while true;do
    case "$1" in
        -a|--auther)
            auther=$2
            shift 2
            ;;
        -u|--user-access)
            user_access=$2
            shift 2
            ;;
        -g|--group-access)
            group_access=$2
            shift 2
            ;;
        -h|--help)
            set +x
            echo Function for svn access contorl
            exit 
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            die "internal error"
            ;;
    esac
done

cmdb-mysql() {
    (
        set +x
        if mysql -u root --password=$(cat /home/qishanqing/.ssh/mysql-cmdb.pass) cmdb -h 192.168.0.232 -e "$@" > /tmp/cmdb.db.$$ 2>&1; then
            cat /tmp/cmdb.db.$$
            rm -f /tmp/cmdb.db.$$
        elif grep 'Duplicate entry' /tmp/cmdb.db.$$; then
            rm -f /tmp/cmdb.db.$$
        else
            die "sql error input cmdb info"
        fi
    )

}

svn-connt() {
    (   set +x 
        if ping -c 5 192.168.0.220 >/dev/null;then
            (
                cat << EOF

[tech:/Branch/${branch}]
$user_access=rw
@admin=rw
*=
EOF
             ) | ssh 192.168.0.220 "cat  >> /svn/authz.conf" || echo "access add error"
        fi 
    )
}

check-acces (){
        grep -c $access /mnt/svn/authz.conf |
	while read num
	do
		if [ $num -eq 0 ]
		then
			echo "authz added "
		else
			return 1
		fi
	}


export -f cmdb-mysql
export -f svn-connt
export -f check-acces

if test $0 = s.sh;then
    cmdb-mysql "update scm set scm_del = 0,scm_del_date=now() WHERE scm_branch like '%$1%';"
else 
    cmdb-mysql "insert into scm(scm_trunk,scm_branch,scm_date,scm_description) values ('$Trunk_name', '$branch_name',now(),'$auther');"
    echo "$branch_name"
    check-acces
    svn-connt
fi

#cmdb-mysql "insert into users values('$user',encrypt('$passwd'));"

set +x


